import { headers } from "next/headers";
import { Metadata } from "next";
import { redirect } from "next/navigation";

/*--------------------------------------------*
 * Methods
 *--------------------------------------------*/
import { getSerializableLoginSettings } from "@lib/zitadel";
import { serverTranslation } from "@i18n/server";
import { getServiceUrlFromHeaders } from "@lib/service-url";
import { loadSessionById, checkSessionFactorValidity } from "@lib/session";
import { getSessionCredentials } from "@lib/cookies";
import { checkAuthenticationLevel, AuthLevel } from "@lib/server/route-protection";
import { logMessage } from "@lib/logger";

/*--------------------------------------------*
 * Components
 *--------------------------------------------*/
import { ChooseSecondFactorToSetup } from "@components/mfa/ChooseSecondFactorToSetup";
import { AuthPanel } from "@components/AuthPanel";

export async function generateMetadata(): Promise<Metadata> {
  const { t } = await serverTranslation("mfa");
  return { title: t("set.title") };
}

export default async function Page() {
  const _headers = await headers();
  const { serviceUrl } = getServiceUrlFromHeaders(_headers);
  const { sessionId, loginName, organization, requestId } = await getSessionCredentials();

  const authCheck = await checkAuthenticationLevel(
    serviceUrl,
    AuthLevel.PASSWORD_REQUIRED,
    loginName,
    organization
  );

  if (!authCheck.satisfied) {
    logMessage.debug({
      message: "MFA set page auth check failed",
      reason: authCheck.reason,
      redirect: authCheck.redirect,
    });
    redirect(authCheck.redirect || "/password");
  }

  const sessionFactors = await loadSessionById(serviceUrl, sessionId, organization);

  if (!sessionFactors) {
    logMessage.debug({
      message: "MFA set page missing session factors",
      hasSessionId: !!sessionId,
      hasOrganization: !!organization,
    });
    redirect("/");
  }

  const loginSettings = await getSerializableLoginSettings({
    serviceUrl,
    organizationId: sessionFactors.factors?.user?.organizationId,
  });

  const { valid } = checkSessionFactorValidity(sessionFactors);

  if (!valid || !sessionFactors.factors?.user?.id) {
    logMessage.debug({
      message: "MFA set page invalid session factors",
      valid,
      hasUserId: !!sessionFactors.factors?.user?.id,
    });
    redirect("/mfa");
  }

  return (
    <>
      <AuthPanel titleI18nKey="set.title" descriptionI18nKey="set.description" namespace="mfa">
        <div className="w-full">
          <div className="flex flex-col space-y-4">
            {valid && loginSettings && sessionFactors && sessionFactors.factors?.user?.id && (
              <ChooseSecondFactorToSetup checkAfter={true} requestId={requestId} />
            )}
          </div>
        </div>
      </AuthPanel>
    </>
  );
}
